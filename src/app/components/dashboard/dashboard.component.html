<div *ngIf="isLoading" class="loading-container">
  <mat-icon class="spin">autorenew</mat-icon>
  <p>Cargando datos del dashboard...</p>
</div>


<div *ngIf="!isLoading" class="title-greeting">
  <div class="form-image">
    <img src="images/avatar-gotita.png" alt="Mascota AquaVision" class="empty-img left-img">
  </div>
  <div>
    <h2>Bienvenido a AquaVision!</h2>
  </div>
  <img src="images/avatar-gotita.png" alt="Mascota AquaVision" class="empty-img right-img">
</div>

<div *ngIf="!isLoading" class="dashboard-container">
  <div class="cards-row slide-left">

    <!-- Card Consumo Promedio (Admin) -->
    <ng-container *ngIf="isAdmin; else userCard1">
      <div class="card consumo-card">
        <div class="consumo-main">
          <span class="consumo-title">Consumo promedio por Hogar</span>
          <span class="consumo-value">{{ consumoPromedio }} m³</span>
        </div>

        <div 
          class="consumo-indicador" 
          [ngClass]="{ 
            'positivo': consumoDiff < 0, 
            'negativo': consumoDiff > 0, 
            'blink-green': consumoDiff < 0, 
            'blink-red': consumoDiff > 0 
          }"
        >
          <ng-container *ngIf="consumoDiff < 0">
            <mat-icon>arrow_downward</mat-icon>
            <span>{{ consumoDiffAbs }}% menor que ayer</span>
          </ng-container>
          <ng-container *ngIf="consumoDiff > 0">
            <mat-icon>arrow_upward</mat-icon>
            <span>{{ consumoDiffAbs }}% mayor que ayer</span>
          </ng-container>
          <span *ngIf="consumoDiff === 0">= igual que ayer</span>
        </div>
      </div>
    </ng-container>

    <!-- Card Consumo Diario (Usuario) -->
    <ng-template #userCard1>
      <a routerLink="/reportes/diario" class="card consumo-card">
        <div class="card-hint">Ir a ver detalles de consumo diario</div>
        <div class="consumo-main">
          <span class="consumo-title">Consumo en lo que va del día:</span>
          <span [style.color]="consumoColor" class="consumo-value">{{ consumoDia }} m³</span>
        </div>

        <div 
          class="consumo-indicador" 
          [ngClass]="{ 
            'positivo': consumoDiff < 0, 
            'negativo': consumoDiff > 0,
            'blink-green': consumoDiff < 0, 
            'blink-red': consumoDiff > 0
          }"
        >
          <ng-container *ngIf="consumoDiff < 0">
            <mat-icon>arrow_downward</mat-icon>
            <span style="padding-bottom:6px ;">{{ consumoDiffAbs }}% menor que ayer</span>
          </ng-container>
          <ng-container *ngIf="consumoDiff > 0">
            <mat-icon>arrow_upward</mat-icon>
            <span>{{ consumoDiffAbs }}% mayor que ayer</span>
          </ng-container>
          <span *ngIf="consumoDiff === 0">= igual que ayer</span>
        </div>
      </a>
    </ng-template>

    <!-- Card Medidores (Admin) -->
    <ng-template #userCard2>
      <a routerLink="/account-settings" class="card info-card">
        <div class="icon-row">
          <mat-icon class="ok-icon">check_circle</mat-icon>
          <span>Medidores conectados: <strong>{{ medidoresConectados }}</strong></span>
        </div>
        <div class="icon-row">
          <mat-icon class="warn-icon">error</mat-icon>
          <span>Medidores desconectados: <strong>{{ medidoresDesconectados }}</strong></span>
        </div>
      </a>
    </ng-template>

    <!-- Card Hogares y Trivias (Admin) -->
    <ng-container *ngIf="isAdmin; else userCard3">
      <div class="card info-card">
        <div class="icon-row">
          <mat-icon>home</mat-icon>
          <span>Total de Hogares: <strong>{{ totalHogaresAdmin }}</strong></span>
        </div>
        <div class="icon-row">
          <mat-icon>celebration</mat-icon>
          <span>Total de Trivias completadas: <strong>{{ totalTriviasAdmin }}</strong></span>
        </div>
      </div>
    </ng-container>

    <!-- Card Alertas (Usuario) -->
<ng-template #userCard3>
  <a routerLink="/consumption-alerts" class="card info-card">
    <div class="card-hint">Ir a notificaciones detalladas</div>

    <div class="icon-row">
      <!-- Ícono y contador dinámico -->
      <mat-icon 
        [ngClass]="{ 'blink-red': cantidadNotificaciones > 0, 'ok-icon': cantidadNotificaciones === 0 }">
        {{ cantidadNotificaciones > 0 ? 'notification_important' : 'notifications_none' }}
      </mat-icon>

      <span>
        <ng-container *ngIf="cantidadNotificaciones > 0; else sinNotificaciones">
          <strong>
            Tenés 
            <span class="notif-count blink-red">({{ cantidadNotificaciones }})</span> 
            notificaciones nuevas
          </strong>
        </ng-container>
        <ng-template #sinNotificaciones>
          <strong>No tenés notificaciones nuevas</strong>
        </ng-template>
      </span>
    </div>
  </a>
</ng-template>
  </div>

  <!-- Gráfico -->
  <div class="chart-card chart-fullwidth slide-bottom">
    <div class="chart-wrapper">
      <h4 class="consumption-hours-title">
        {{ isAdmin ? 'Consumo total de hogares por hora' : 'Tus consumos por hora' }}
      </h4>
      <canvas
        baseChart
        [data]="isAdmin ? lineChartDataAdmin : lineChartData"
        [options]="lineChartOptions"
        type="line"
        (chartClick)="onChartClick($event)">
      </canvas>
    </div>
  </div>
</div>
